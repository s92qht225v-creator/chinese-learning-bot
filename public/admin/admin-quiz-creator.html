<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Quiz Admin Panel - Create Questions</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&display=swap" rel="stylesheet"/>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#448fe4",
            "secondary": "#50E3C2",
            "accent": "#F5A623",
            "success": "#4CAF50"
          }
        }
      }
    };
  </script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .form-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #448fe4;
      background: rgba(68, 143, 228, 0.05);
    }

    .textarea-field {
      min-height: 100px;
      resize: vertical;
    }

    .question-type-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-type-card:hover {
      border-color: #448fe4;
      background: rgba(68, 143, 228, 0.05);
    }

    .question-type-card.selected {
      border-color: #448fe4;
      background: rgba(68, 143, 228, 0.1);
      box-shadow: 0 4px 12px rgba(68, 143, 228, 0.2);
    }

    .option-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }

    .preview-box {
      background: #f8f9fa;
      border: 2px dashed #448fe4;
      border-radius: 16px;
      padding: 24px;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900">
  
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Quiz Admin Panel</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">Create and manage quiz questions</p>
        </div>
        <div class="flex gap-3">
          <button onclick="viewAllQuestions()" class="px-4 py-2 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary/5">
            <span class="material-symbols-outlined text-sm">list</span>
            View All
          </button>
          <button onclick="previewQuestion()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">
            <span class="material-symbols-outlined text-sm">visibility</span>
            Preview
          </button>
          <button onclick="saveQuestion()" class="px-6 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-primary/90">
            <span class="material-symbols-outlined text-sm">save</span>
            Save Question
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    
    <!-- Question Type Selection -->
    <section class="form-card">
      <h2 class="text-xl font-bold mb-4">1. Select Question Type</h2>
      <p class="text-sm text-gray-500 mb-4">Choose the format for this question</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="question-type-card" onclick="selectQuestionType('multiple_choice')" data-type="multiple_choice">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üìù</span>
            <div>
              <p class="font-semibold">Multiple Choice</p>
              <p class="text-xs text-gray-500">A, B, C, D options</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('fill_gap')" data-type="fill_gap">
          <div class="flex items-center gap-3">
            <span class="text-3xl">‚úèÔ∏è</span>
            <div>
              <p class="font-semibold">Fill in the Gap</p>
              <p class="text-xs text-gray-500">Type missing word</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('true_false')" data-type="true_false">
          <div class="flex items-center gap-3">
            <span class="text-3xl">‚úì</span>
            <div>
              <p class="font-semibold">True/False</p>
              <p class="text-xs text-gray-500">Binary choice</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('matching')" data-type="matching">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üîó</span>
            <div>
              <p class="font-semibold">Matching</p>
              <p class="text-xs text-gray-500">Connect pairs</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('image_association')" data-type="image_association">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üñºÔ∏è</span>
            <div>
              <p class="font-semibold">Image Association</p>
              <p class="text-xs text-gray-500">Image + options</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('sentence_ordering')" data-type="sentence_ordering">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üìã</span>
            <div>
              <p class="font-semibold">Sentence Ordering</p>
              <p class="text-xs text-gray-500">Arrange words</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('grammar_choice')" data-type="grammar_choice">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üìñ</span>
            <div>
              <p class="font-semibold">Grammar Choice</p>
              <p class="text-xs text-gray-500">Pick correct word</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('error_correction')" data-type="error_correction">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üîç</span>
            <div>
              <p class="font-semibold">Error Correction</p>
              <p class="text-xs text-gray-500">Find mistake</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('cloze_test')" data-type="cloze_test">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üìÑ</span>
            <div>
              <p class="font-semibold">Cloze Test</p>
              <p class="text-xs text-gray-500">Multiple blanks</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('dictation')" data-type="dictation">
          <div class="flex items-center gap-3">
            <span class="text-3xl">‚úçÔ∏è</span>
            <div>
              <p class="font-semibold">Dictation</p>
              <p class="text-xs text-gray-500">Listen & type</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('audio_comprehension')" data-type="audio_comprehension">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üéß</span>
            <div>
              <p class="font-semibold">Audio Comprehension</p>
              <p class="text-xs text-gray-500">Listen & answer</p>
            </div>
          </div>
        </div>

        <div class="question-type-card" onclick="selectQuestionType('audio_to_word')" data-type="audio_to_word">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üëÇ</span>
            <div>
              <p class="font-semibold">Audio to Word</p>
              <p class="text-xs text-gray-500">Hear & select</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Basic Information -->
    <section class="form-card">
      <h2 class="text-xl font-bold mb-4">2. Basic Information</h2>
      
      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">HSK Level *</label>
        <select id="hskLevel" class="input-field">
          <option value="">Select level...</option>
          <option value="HSK1">HSK 1 - Beginner (150 words)</option>
          <option value="HSK2">HSK 2 - Elementary (300 words)</option>
          <option value="HSK3">HSK 3 - Intermediate (600 words)</option>
          <option value="HSK4">HSK 4 - Upper Intermediate (1200 words)</option>
          <option value="HSK5">HSK 5 - Advanced (2500 words)</option>
          <option value="HSK6">HSK 6 - Mastery (5000+ words)</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">HSK level defines the difficulty - no separate difficulty setting needed</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Tags (comma separated)</label>
        <input type="text" id="tags" class="input-field" placeholder="e.g., grammar, vocabulary, daily life">
        <p class="text-xs text-gray-500 mt-1">Use tags to organize questions by topic</p>
      </div>
    </section>

    <!-- Dynamic Form Container -->
    <div id="questionFormContainer">
      <!-- Form will be inserted here based on selected type -->
    </div>

  </main>

  <script>
    console.log('üî• Quiz Creator Script Loaded');
    let selectedType = null;
    let currentQuestion = {};

    // Get admin password helper
    async function getAdminPassword() {
      let adminPassword = localStorage.getItem('adminPassword');
      if (!adminPassword) {
        adminPassword = prompt('Enter admin password:');
        if (adminPassword) {
          localStorage.setItem('adminPassword', adminPassword.trim());
        }
      }
      return adminPassword;
    }

    // Handle audio file upload via backend API
    async function handleAudioUpload(input) {
      const file = input.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('audioUploadStatus');
      statusDiv.innerHTML = '<span style="color: #448fe4;">‚è≥ Uploading...</span>';

      try {
        const password = await getAdminPassword();
        if (!password) {
          statusDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Admin password required</span>';
          return;
        }

        const formData = new FormData();
        formData.append('audio', file);

        const response = await fetch('/api/admin/upload-audio', {
          method: 'POST',
          headers: { 'X-Admin-Password': password },
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }

        const data = await response.json();
        document.getElementById('audioUrl').value = data.url;
        statusDiv.innerHTML = '<span style="color: #4CAF50;">‚úì Uploaded successfully!</span>';
      } catch (error) {
        console.error('Upload error:', error);
        statusDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Upload failed: ' + error.message + '</span>';
      }
    }

    // Handle image file upload via backend API
    async function handleImageUpload(input) {
      const file = input.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('imageUploadStatus');
      const imagePreview = document.getElementById('imagePreview');
      const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');

      statusDiv.innerHTML = '<span style="color: #448fe4;">‚è≥ Uploading...</span>';

      try {
        const password = await getAdminPassword();
        if (!password) {
          statusDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Admin password required</span>';
          return;
        }

        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/admin/upload-image', {
          method: 'POST',
          headers: { 'X-Admin-Password': password },
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }

        const data = await response.json();
        document.getElementById('imageUrl').value = data.url;
        statusDiv.innerHTML = '<span style="color: #4CAF50;">‚úì Uploaded successfully!</span>';

        // Show preview
        imagePreview.src = data.url;
        imagePreview.classList.remove('hidden');
        imagePreviewPlaceholder.classList.add('hidden');
      } catch (error) {
        console.error('Upload error:', error);
        statusDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Upload failed: ' + error.message + '</span>';
      }
    }

    // Select question type
    function selectQuestionType(type) {
      selectedType = type;
      
      // Update UI
      document.querySelectorAll('.question-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-type="${type}"]`).classList.add('selected');
      
      // Load appropriate form
      loadFormForType(type);
    }

    // Load form based on type
    function loadFormForType(type) {
      const container = document.getElementById('questionFormContainer');
      
      switch(type) {
        case 'multiple_choice':
          container.innerHTML = getMultipleChoiceForm();
          break;
        case 'fill_gap':
          container.innerHTML = getFillGapForm();
          break;
        case 'true_false':
          container.innerHTML = getTrueFalseForm();
          break;
        case 'matching':
          container.innerHTML = getMatchingForm();
          break;
        case 'image_association':
          container.innerHTML = getImageAssociationForm();
          break;
        case 'sentence_ordering':
          container.innerHTML = getSentenceOrderingForm();
          break;
        case 'grammar_choice':
          container.innerHTML = getGrammarChoiceForm();
          break;
        case 'error_correction':
          container.innerHTML = getErrorCorrectionForm();
          break;
        case 'cloze_test':
          container.innerHTML = getClozeTestForm();
          break;
        case 'dictation':
          container.innerHTML = getDictationForm();
          break;
        case 'audio_comprehension':
          container.innerHTML = getAudioComprehensionForm();
          break;
        case 'audio_to_word':
          container.innerHTML = getAudioToWordForm();
          break;
      }
    }

    // Form Templates
    function getMultipleChoiceForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., What does this mean?">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Chinese Text (if applicable)</label>
            <input type="text" id="chineseText" class="input-field" placeholder="e.g., ÊâãË°®" style="font-size: 24px;">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Audio File (optional)</label>
            <div id="currentAudioDisplay" class="hidden mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <p class="text-sm font-semibold text-blue-900 mb-2">Current Audio:</p>
              <audio id="audioPreview" controls class="w-full mb-2">
                <source type="audio/mpeg">
              </audio>
              <p class="text-xs text-blue-600 break-all" id="audioUrlDisplay"></p>
            </div>
            <input type="file" id="audioFileInput" class="input-field" accept="audio/*" onchange="handleAudioUpload(this)">
            <input type="hidden" id="audioUrl">
            <div id="audioUploadStatus" class="text-sm mt-2"></div>
            <p class="text-xs text-gray-500 mt-1">Upload new audio file to replace existing (optional)</p>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Answer Options</h2>
          
          <div id="optionsContainer">
            <div class="option-row">
              <input type="radio" name="correct" value="a" id="correct_a">
              <label for="correct_a" class="text-sm font-semibold w-8">A</label>
              <input type="text" id="option_a" class="input-field" placeholder="Option A">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="b" id="correct_b">
              <label for="correct_b" class="text-sm font-semibold w-8">B</label>
              <input type="text" id="option_b" class="input-field" placeholder="Option B">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="c" id="correct_c">
              <label for="correct_c" class="text-sm font-semibold w-8">C</label>
              <input type="text" id="option_c" class="input-field" placeholder="Option C">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="d" id="correct_d">
              <label for="correct_d" class="text-sm font-semibold w-8">D</label>
              <input type="text" id="option_d" class="input-field" placeholder="Option D">
            </div>
          </div>

          <p class="text-sm text-gray-500 mt-2">‚úì Select the radio button for the correct answer</p>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">5. Explanation</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Explanation for Review *</label>
            <textarea id="explanation" class="input-field textarea-field" placeholder="Explain why this answer is correct and provide additional context..."></textarea>
            <p class="text-xs text-gray-500 mt-1">This will be shown when students review their mistakes</p>
          </div>
        </section>
      `;
    }

    function getFillGapForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Complete the sentence:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Sentence with Gap *</label>
            <input type="text" id="sentenceText" class="input-field" placeholder="e.g., Êàë ___ Â≠¶Áîü„ÄÇ" style="font-size: 20px;">
            <p class="text-xs text-gray-500 mt-1">Use ___ to indicate where the gap is</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Translation (optional)</label>
            <input type="text" id="translation" class="input-field" placeholder="e.g., I ___ a student.">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Correct Answer *</label>
            <input type="text" id="correctAnswer" class="input-field" placeholder="e.g., ÊòØ">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Alternative Acceptable Answers</label>
            <input type="text" id="acceptableAnswers" class="input-field" placeholder="e.g., shi, sh√¨ (comma separated)">
            <p class="text-xs text-gray-500 mt-1">Include pinyin variations and alternative spellings</p>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the grammar rule or vocabulary..."></textarea>
        </section>
      `;
    }

    function getTrueFalseForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Statement</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Statement *</label>
            <input type="text" id="statement" class="input-field" placeholder="e.g., ÊâãË°® means 'newspaper'">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Correct Answer *</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="trueFalse" value="true" id="true">
                <span class="font-semibold">True</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="trueFalse" value="false" id="false">
                <span class="font-semibold">False</span>
              </label>
            </div>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain why the statement is true or false..."></textarea>
        </section>
      `;
    }

    function getMatchingForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Match the Chinese words to their English meanings:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-4">Matching Pairs * (minimum 3)</label>
            
            <div id="pairsContainer">
              <div class="option-row mb-3">
                <input type="text" class="input-field" placeholder="Chinese" id="chinese_1" style="flex: 1; font-size: 18px;">
                <span class="text-2xl">‚Üí</span>
                <input type="text" class="input-field" placeholder="English" id="english_1" style="flex: 1;">
              </div>

              <div class="option-row mb-3">
                <input type="text" class="input-field" placeholder="Chinese" id="chinese_2" style="flex: 1; font-size: 18px;">
                <span class="text-2xl">‚Üí</span>
                <input type="text" class="input-field" placeholder="English" id="english_2" style="flex: 1;">
              </div>

              <div class="option-row mb-3">
                <input type="text" class="input-field" placeholder="Chinese" id="chinese_3" style="flex: 1; font-size: 18px;">
                <span class="text-2xl">‚Üí</span>
                <input type="text" class="input-field" placeholder="English" id="english_3" style="flex: 1;">
              </div>
            </div>

            <button onclick="addPair()" class="px-4 py-2 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary/5">
              + Add Another Pair
            </button>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Provide additional context or memory tips..."></textarea>
        </section>
      `;
    }

    function getImageAssociationForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., What is this?">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Image File *</label>
            <input type="file" id="imageFileInput" class="input-field" accept="image/*" onchange="handleImageUpload(this)">
            <input type="hidden" id="imageUrl">
            <div id="imageUploadStatus" class="text-sm mt-2"></div>
            <p class="text-xs text-gray-500 mt-1">Upload image file to Supabase</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Image Preview</label>
            <div class="max-w-md border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 p-4">
              <span class="text-gray-400" id="imagePreviewPlaceholder">No image</span>
              <img id="imagePreview" src="" alt="Preview" class="hidden max-w-full h-auto rounded-lg">
            </div>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Answer Options</h2>
          
          <div id="optionsContainer">
            <div class="option-row">
              <input type="radio" name="correct" value="a" id="correct_a">
              <label for="correct_a" class="text-sm font-semibold w-8">A</label>
              <input type="text" id="option_a" class="input-field" placeholder="Chinese word A" style="font-size: 18px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="b" id="correct_b">
              <label for="correct_b" class="text-sm font-semibold w-8">B</label>
              <input type="text" id="option_b" class="input-field" placeholder="Chinese word B" style="font-size: 18px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="c" id="correct_c">
              <label for="correct_c" class="text-sm font-semibold w-8">C</label>
              <input type="text" id="option_c" class="input-field" placeholder="Chinese word C" style="font-size: 18px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="d" id="correct_d">
              <label for="correct_d" class="text-sm font-semibold w-8">D</label>
              <input type="text" id="option_d" class="input-field" placeholder="Chinese word D" style="font-size: 18px;">
            </div>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">5. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the correct answer..."></textarea>
        </section>
      `;
    }

    function getSentenceOrderingForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Arrange these words in the correct order:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Correct Sentence *</label>
            <input type="text" id="correctSentence" class="input-field" placeholder="e.g., Êàë‰πüÊòØÂ≠¶Áîü" style="font-size: 20px;">
            <p class="text-xs text-gray-500 mt-1">Enter the sentence in correct order (spaces will separate words)</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Translation *</label>
            <input type="text" id="translation" class="input-field" placeholder="e.g., I am also a student">
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the correct word order and grammar rules..."></textarea>
        </section>
      `;
    }

    function getGrammarChoiceForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Choose the correct word to complete the sentence:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Sentence with Gap *</label>
            <input type="text" id="sentenceText" class="input-field" placeholder="e.g., Êàë ___ Â≠¶Áîü„ÄÇ" style="font-size: 20px;">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Grammar Options</label>
            
            <div class="option-row">
              <input type="radio" name="correct" value="a" id="correct_a">
              <label for="correct_a" class="text-sm font-semibold w-8">A</label>
              <input type="text" id="option_a" class="input-field" placeholder="Grammar word A" style="font-size: 18px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="b" id="correct_b">
              <label for="correct_b" class="text-sm font-semibold w-8">B</label>
              <input type="text" id="option_b" class="input-field" placeholder="Grammar word B" style="font-size: 18px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="c" id="correct_c">
              <label for="correct_c" class="text-sm font-semibold w-8">C</label>
              <input type="text" id="option_c" class="input-field" placeholder="Grammar word C" style="font-size: 18px;">
            </div>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the grammar rule and why other options are incorrect..."></textarea>
        </section>
      `;
    }

    function getErrorCorrectionForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Find and correct the error in this sentence:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Incorrect Sentence *</label>
            <input type="text" id="incorrectSentence" class="input-field" placeholder="e.g., ‰ªñÂ≠¶Áîü‰πüÊòØ" style="font-size: 20px;">
            <p class="text-xs text-gray-500 mt-1">Enter sentence with space-separated words</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Which Word Position is Wrong? *</label>
            <input type="number" id="errorIndex" class="input-field" placeholder="e.g., 2 (zero-indexed: 0,1,2,3...)" min="0">
            <p class="text-xs text-gray-500 mt-1">Count starts from 0. For "‰ªñÂ≠¶Áîü‰πüÊòØ", ‰πü is at index 2</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Correct Sentence *</label>
            <input type="text" id="correctSentence" class="input-field" placeholder="e.g., ‰ªñ‰πüÊòØÂ≠¶Áîü" style="font-size: 20px;">
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain why the word position is wrong and the correct grammar rule..."></textarea>
        </section>
      `;
    }

    function getClozeTestForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Fill in all the blanks:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Passage with Blanks *</label>
            <textarea id="passage" class="input-field textarea-field" placeholder="e.g., Êàë___ÊùéÊòé„ÄÇÊàë___Â≠¶Áîü„ÄÇÊàëÊØèÂ§©___‰∏ÉÁÇπËµ∑Â∫ä„ÄÇ" style="font-size: 18px;"></textarea>
            <p class="text-xs text-gray-500 mt-1">Use ___ to mark blanks</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-4">Answers for Each Blank *</label>
            
            <div id="blanksContainer">
              <div class="mb-3">
                <label class="block text-xs font-semibold mb-1">Blank 1:</label>
                <input type="text" id="blank_1_answer" class="input-field" placeholder="Correct answer">
                <input type="text" id="blank_1_acceptable" class="input-field mt-2" placeholder="Alternative answers (comma separated)">
              </div>

              <div class="mb-3">
                <label class="block text-xs font-semibold mb-1">Blank 2:</label>
                <input type="text" id="blank_2_answer" class="input-field" placeholder="Correct answer">
                <input type="text" id="blank_2_acceptable" class="input-field mt-2" placeholder="Alternative answers (comma separated)">
              </div>

              <div class="mb-3">
                <label class="block text-xs font-semibold mb-1">Blank 3:</label>
                <input type="text" id="blank_3_answer" class="input-field" placeholder="Correct answer">
                <input type="text" id="blank_3_acceptable" class="input-field mt-2" placeholder="Alternative answers (comma separated)">
              </div>
            </div>

            <button onclick="addBlank()" class="px-4 py-2 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary/5">
              + Add Another Blank
            </button>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the passage and answers..."></textarea>
        </section>
      `;
    }

    function getDictationForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Listen to the audio and type what you hear:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Audio URL *</label>
            <input type="text" id="audioUrl" class="input-field" placeholder="/audio/wo-shi-xuesheng.mp3">
            <p class="text-xs text-gray-500 mt-1">Upload audio file and paste URL</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Correct Answer (Chinese) *</label>
            <input type="text" id="correctAnswer" class="input-field" placeholder="e.g., ÊàëÊòØÂ≠¶Áîü" style="font-size: 20px;">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Alternative Acceptable Answers</label>
            <input type="text" id="acceptableAnswers" class="input-field" placeholder="e.g., wo shi xuesheng, w«í sh√¨ xu√©sheng">
            <p class="text-xs text-gray-500 mt-1">Include pinyin variations</p>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the meaning and any tricky pronunciation..."></textarea>
        </section>
      `;
    }

    function getAudioComprehensionForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Audio Content</h2>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Listen to the conversation and answer:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Upload Audio File *</label>
            <div id="currentAudioDisplay" class="hidden mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <p class="text-sm font-semibold text-blue-900 mb-2">Current Audio:</p>
              <audio id="audioPreview" controls class="w-full mb-2">
                <source type="audio/mpeg">
              </audio>
              <p class="text-xs text-blue-600 break-all" id="audioUrlDisplay"></p>
            </div>
            <input type="file" id="audioFileInput" class="input-field" accept="audio/*" onchange="handleAudioUpload(this)">
            <input type="hidden" id="audioUrl">
            <div id="audioUploadStatus" class="text-sm mt-2"></div>
            <p class="text-xs text-gray-500 mt-1">Upload new audio file to replace existing (optional)</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Transcript (optional)</label>
            <textarea id="transcript" class="input-field textarea-field" placeholder="A: ‰Ω†ÂéªÂì™ÂÑøÔºü&#10;B: ÊàëÂéªÂõæ‰π¶È¶Ü„ÄÇ" style="font-size: 16px;"></textarea>
            <p class="text-xs text-gray-500 mt-1">This will be revealed when students review mistakes</p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Comprehension Question *</label>
            <input type="text" id="comprehensionQuestion" class="input-field" placeholder="e.g., Where is person B going?">
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Answer Options</h2>
          
          <div id="optionsContainer">
            <div class="option-row">
              <input type="radio" name="correct" value="a" id="correct_a">
              <label for="correct_a" class="text-sm font-semibold w-8">A</label>
              <input type="text" id="option_a" class="input-field" placeholder="Option A">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="b" id="correct_b">
              <label for="correct_b" class="text-sm font-semibold w-8">B</label>
              <input type="text" id="option_b" class="input-field" placeholder="Option B">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="c" id="correct_c">
              <label for="correct_c" class="text-sm font-semibold w-8">C</label>
              <input type="text" id="option_c" class="input-field" placeholder="Option C">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="d" id="correct_d">
              <label for="correct_d" class="text-sm font-semibold w-8">D</label>
              <input type="text" id="option_d" class="input-field" placeholder="Option D">
            </div>
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">5. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the correct answer and key vocabulary..."></textarea>
        </section>
      `;
    }

    function getAudioToWordForm() {
      return `
        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">3. Question Content</h2>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Question Text *</label>
            <input type="text" id="questionText" class="input-field" placeholder="e.g., Listen and select the word you hear:">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Audio URL *</label>
            <input type="text" id="audioUrl" class="input-field" placeholder="/audio/mama.mp3">
          </div>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">4. Answer Options (with tones)</h2>
          
          <div id="optionsContainer">
            <div class="option-row">
              <input type="radio" name="correct" value="a" id="correct_a">
              <label for="correct_a" class="text-sm font-semibold w-8">A</label>
              <input type="text" id="option_a" class="input-field" placeholder="e.g., Â¶àÂ¶à (mƒÅma - mother)" style="font-size: 16px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="b" id="correct_b">
              <label for="correct_b" class="text-sm font-semibold w-8">B</label>
              <input type="text" id="option_b" class="input-field" placeholder="e.g., È©¨È©¨ (m«éma - horses)" style="font-size: 16px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="c" id="correct_c">
              <label for="correct_c" class="text-sm font-semibold w-8">C</label>
              <input type="text" id="option_c" class="input-field" placeholder="e.g., È™ÇÂ¶à (m√†ma)" style="font-size: 16px;">
            </div>

            <div class="option-row">
              <input type="radio" name="correct" value="d" id="correct_d">
              <label for="correct_d" class="text-sm font-semibold w-8">D</label>
              <input type="text" id="option_d" class="input-field" placeholder="e.g., È∫ªÈ∫ª (m√°ma)" style="font-size: 16px;">
            </div>
          </div>

          <p class="text-sm text-gray-500 mt-2">üí° Include pinyin with tone marks in each option</p>
        </section>

        <section class="form-card">
          <h2 class="text-xl font-bold mb-4">5. Explanation</h2>
          <textarea id="explanation" class="input-field textarea-field" placeholder="Explain the correct tone and meaning..."></textarea>
        </section>
      `;
    }

    // Helper functions
    function addPair() {
      const container = document.getElementById('pairsContainer');
      const pairCount = container.children.length + 1;
      const html = `
        <div class="option-row mb-3">
          <input type="text" class="input-field" placeholder="Chinese" id="chinese_${pairCount}" style="flex: 1; font-size: 18px;">
          <span class="text-2xl">‚Üí</span>
          <input type="text" class="input-field" placeholder="English" id="english_${pairCount}" style="flex: 1;">
          <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function addBlank() {
      const container = document.getElementById('blanksContainer');
      const blankCount = container.children.length + 1;
      const html = `
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Blank ${blankCount}:</label>
          <input type="text" id="blank_${blankCount}_answer" class="input-field" placeholder="Correct answer">
          <input type="text" id="blank_${blankCount}_acceptable" class="input-field mt-2" placeholder="Alternative answers (comma separated)">
          <button onclick="this.parentElement.remove()" class="text-sm text-red-500 hover:text-red-700 mt-1">Remove</button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    // Preview question
    function previewQuestion() {
      if (!selectedType) {
        alert('Please select a question type first!');
        return;
      }

      // Collect current form data
      const previewData = collectFormData();
      
      // Show preview modal
      showPreviewModal(previewData);
    }

    function collectFormData() {
      const data = {
        type: selectedType,
        level: document.getElementById('hskLevel')?.value,
        questionText: document.getElementById('questionText')?.value,
        chineseText: document.getElementById('chineseText')?.value,
        audioUrl: document.getElementById('audioUrl')?.value,
        explanation: document.getElementById('explanation')?.value
      };

      // Collect type-specific data
      if (['multiple_choice', 'grammar_choice', 'image_association', 'audio_comprehension', 'audio_to_word'].includes(selectedType)) {
        data.options = [
          { id: 'a', text: document.getElementById('option_a')?.value, correct: document.getElementById('correct_a')?.checked },
          { id: 'b', text: document.getElementById('option_b')?.value, correct: document.getElementById('correct_b')?.checked },
          { id: 'c', text: document.getElementById('option_c')?.value, correct: document.getElementById('correct_c')?.checked },
          { id: 'd', text: document.getElementById('option_d')?.value, correct: document.getElementById('correct_d')?.checked }
        ];
      }

      if (selectedType === 'grammar_choice') {
        data.sentence = document.getElementById('sentenceText')?.value;
      }

      if (selectedType === 'fill_gap') {
        data.sentence = document.getElementById('sentenceText')?.value;
        data.translation = document.getElementById('translation')?.value;
        data.correctAnswer = document.getElementById('correctAnswer')?.value;
      }

      if (selectedType === 'true_false') {
        data.statement = document.getElementById('statement')?.value;
        data.correctAnswer = document.querySelector('input[name="trueFalse"]:checked')?.value;
      }

      if (selectedType === 'sentence_ordering') {
        data.correctSentence = document.getElementById('correctSentence')?.value;
        data.translation = document.getElementById('translation')?.value;
      }

      if (selectedType === 'error_correction') {
        data.incorrectSentence = document.getElementById('incorrectSentence')?.value;
        data.correctSentence = document.getElementById('correctSentence')?.value;
        data.errorIndex = document.getElementById('errorIndex')?.value;
      }

      if (selectedType === 'dictation' || selectedType === 'repeat_after_me') {
        data.targetPhrase = document.getElementById('targetPhrase')?.value || document.getElementById('correctAnswer')?.value;
        data.pinyin = document.getElementById('pinyin')?.value;
        data.translation = document.getElementById('translation')?.value;
      }

      if (selectedType === 'audio_comprehension') {
        data.transcript = document.getElementById('transcript')?.value;
        data.comprehensionQuestion = document.getElementById('comprehensionQuestion')?.value;
      }

      if (selectedType === 'image_association') {
        data.imageUrl = document.getElementById('imageUrl')?.value;
      }

      if (selectedType === 'cloze_test') {
        data.passage = document.getElementById('passage')?.value;

        // Collect all blank answers
        const blanks = [];
        let blankIndex = 1;

        while (true) {
          const answerInput = document.getElementById(`blank_${blankIndex}_answer`);
          const acceptableInput = document.getElementById(`blank_${blankIndex}_acceptable`);

          if (!answerInput || !answerInput.value) break;

          blanks.push({
            blank_num: blankIndex,
            correct: answerInput.value.trim(),
            acceptable: acceptableInput?.value ? acceptableInput.value.split(',').map(a => a.trim()).filter(a => a) : []
          });

          blankIndex++;
        }

        data.blanks = blanks;
      }

      return data;
    }

    function showPreviewModal(data) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.id = 'previewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;

      // Create modal content
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      `;

      const typeIcons = {
        multiple_choice: 'üìù',
        fill_gap: '‚úèÔ∏è',
        true_false: '‚úì',
        matching: 'üîó',
        image_association: 'üñºÔ∏è',
        sentence_ordering: 'üìã',
        grammar_choice: 'üìñ',
        error_correction: 'üîç',
        cloze_test: 'üìÑ',
        dictation: '‚úçÔ∏è',
        audio_comprehension: 'üéß',
        audio_to_word: 'üëÇ'
      };

      const typeNames = {
        multiple_choice: 'Multiple Choice',
        fill_gap: 'Fill in the Gap',
        true_false: 'True/False',
        matching: 'Matching',
        image_association: 'Image Association',
        sentence_ordering: 'Sentence Ordering',
        grammar_choice: 'Grammar Choice',
        error_correction: 'Error Correction',
        cloze_test: 'Cloze Test',
        dictation: 'Dictation',
        audio_comprehension: 'Audio Comprehension',
        audio_to_word: 'Audio to Word'
      };

      content.innerHTML = `
        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
          <div style="display: flex; justify-content: between; align-items: center;">
            <div>
              <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 8px;">Question Preview</h2>
              <p style="font-size: 14px; color: #6b7280;">This is how students will see this question</p>
            </div>
            <button onclick="closePreview()" style="padding: 8px; border-radius: 8px; background: #f3f4f6; border: none; cursor: pointer; margin-left: auto;">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>

        <div style="padding: 24px;">
          <!-- Header -->
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
            <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: bold;">${data.level || 'No Level'}</span>
            <span style="background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: bold;">${typeIcons[data.type]} ${typeNames[data.type]}</span>
          </div>

          <!-- Question Content -->
          ${renderPreviewContent(data)}

          <!-- Explanation -->
          ${data.explanation ? `
            <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-left: 4px solid #448fe4; border-radius: 8px;">
              <p style="font-size: 12px; font-weight: bold; color: #448fe4; margin-bottom: 8px;">üí° EXPLANATION (shown after answer)</p>
              <p style="font-size: 14px; line-height: 1.6;">${data.explanation}</p>
            </div>
          ` : ''}
        </div>

        <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px;">
          <button onclick="closePreview()" style="flex: 1; padding: 12px; border-radius: 12px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
            Close Preview
          </button>
          <button onclick="closePreview(); saveQuestion();" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: #448fe4; color: white; font-weight: 600; cursor: pointer;">
            Looks Good - Save Question
          </button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closePreview();
      });
    }

    function renderPreviewContent(data) {
      let html = '';

      // Question text
      if (data.questionText) {
        html += `<h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">${data.questionText}</h3>`;
      }

      // Chinese text (large display)
      if (data.chineseText) {
        html += `
          <div style="text-align: center; margin: 24px 0;">
            <p style="font-size: 48px; font-weight: bold; color: #448fe4;">${data.chineseText}</p>
            ${data.audioUrl ? `
              <button style="margin-top: 12px; padding: 8px 16px; background: rgba(68, 143, 228, 0.1); border: none; border-radius: 8px; color: #448fe4; font-weight: 600; cursor: pointer;">
                <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">volume_up</span>
                Play Audio
              </button>
            ` : ''}
          </div>
        `;
      }

      // Type-specific rendering
      switch(data.type) {
        case 'multiple_choice':
        case 'audio_to_word':
          if (data.options) {
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            data.options.forEach(opt => {
              const isCorrect = opt.correct;
              html += `
                <div style="padding: 16px; border: 2px solid ${isCorrect ? '#4ade80' : '#e5e7eb'}; background: ${isCorrect ? 'rgba(74, 222, 128, 0.05)' : 'white'}; border-radius: 12px; display: flex; align-items: center; gap: 12px;">
                  <span style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">${opt.id.toUpperCase()}</span>
                  <span style="font-size: 16px; font-weight: 500;">${opt.text || '(empty)'}</span>
                  ${isCorrect ? '<span style="margin-left: auto; color: #4ade80; font-weight: bold;">‚úì</span>' : ''}
                </div>
              `;
            });
            html += '</div>';
          }
          break;

        case 'audio_comprehension':
          // Show audio icon
          if (data.audioUrl) {
            html += `
              <div style="padding: 24px; background: linear-gradient(135deg, rgba(68, 143, 228, 0.1), rgba(80, 227, 194, 0.1)); border: 2px solid rgba(68, 143, 228, 0.3); border-radius: 16px; text-align: center; margin-bottom: 16px;">
                <span class="material-symbols-outlined" style="font-size: 48px; color: #448fe4;">headphones</span>
                <p style="margin-top: 12px; font-weight: 600;">Audio Conversation</p>
                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Students will listen to audio</p>
              </div>
            `;
          }
          // Show transcript
          if (data.transcript) {
            html += `
              <div style="padding: 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px;">
                <p style="font-size: 12px; font-weight: bold; color: #6b7280; margin-bottom: 8px;">TRANSCRIPT (shown after answer):</p>
                <p style="font-size: 14px; line-height: 1.6; white-space: pre-line;">${data.transcript}</p>
              </div>
            `;
          }
          // Show comprehension question
          if (data.comprehensionQuestion) {
            html += `
              <div style="padding: 16px; background: #f0f9ff; border-left: 4px solid #448fe4; border-radius: 8px; margin-bottom: 16px;">
                <p style="font-size: 16px; font-weight: bold;">${data.comprehensionQuestion}</p>
              </div>
            `;
          }
          // Show options
          if (data.options) {
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            data.options.forEach(opt => {
              const isCorrect = opt.correct;
              html += `
                <div style="padding: 16px; border: 2px solid ${isCorrect ? '#4ade80' : '#e5e7eb'}; background: ${isCorrect ? 'rgba(74, 222, 128, 0.05)' : 'white'}; border-radius: 12px; display: flex; align-items: center; gap: 12px;">
                  <span style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">${opt.id.toUpperCase()}</span>
                  <span style="font-size: 16px; font-weight: 500;">${opt.text || '(empty)'}</span>
                  ${isCorrect ? '<span style="margin-left: auto; color: #4ade80; font-weight: bold;">‚úì</span>' : ''}
                </div>
              `;
            });
            html += '</div>';
          }
          break;

        case 'grammar_choice':
          // Show sentence with gap
          if (data.sentence) {
            html += `
              <div style="padding: 24px; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; margin-bottom: 16px;">
                <p style="font-size: 12px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">SENTENCE WITH GAP:</p>
                <p style="font-size: 24px; font-weight: bold; text-align: center;">${data.sentence}</p>
              </div>
            `;
          }
          // Show options (only 3 for grammar choice)
          if (data.options) {
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            data.options.forEach(opt => {
              // Skip empty 4th option
              if (!opt.text || opt.text.trim() === '') return;

              const isCorrect = opt.correct;
              html += `
                <div style="padding: 16px; border: 2px solid ${isCorrect ? '#4ade80' : '#e5e7eb'}; background: ${isCorrect ? 'rgba(74, 222, 128, 0.05)' : 'white'}; border-radius: 12px; display: flex; align-items: center; gap: 12px;">
                  <span style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">${opt.id.toUpperCase()}</span>
                  <span style="font-size: 16px; font-weight: 500;">${opt.text}</span>
                  ${isCorrect ? '<span style="margin-left: auto; color: #4ade80; font-weight: bold;">‚úì</span>' : ''}
                </div>
              `;
            });
            html += '</div>';
          }
          break;

        case 'fill_gap':
          if (data.sentence) {
            html += `
              <div style="padding: 24px; background: #f9fafb; border-radius: 12px; text-align: center; margin-bottom: 16px;">
                <p style="font-size: 24px; font-weight: bold; margin-bottom: 8px;">${data.sentence}</p>
                ${data.translation ? `<p style="font-size: 14px; color: #6b7280;">${data.translation}</p>` : ''}
              </div>
              <div style="padding: 16px; background: rgba(74, 222, 128, 0.1); border: 2px solid #4ade80; border-radius: 12px;">
                <p style="font-size: 12px; font-weight: bold; color: #15803d; margin-bottom: 4px;">CORRECT ANSWER:</p>
                <p style="font-size: 20px; font-weight: bold;">${data.correctAnswer || '(not set)'}</p>
              </div>
            `;
          }
          break;

        case 'true_false':
          if (data.statement) {
            html += `
              <div style="padding: 24px; background: #f9fafb; border-radius: 12px; text-align: center; margin-bottom: 16px;">
                <p style="font-size: 20px; font-weight: bold;">${data.statement}</p>
              </div>
              <div style="display: flex; gap: 12px;">
                <div style="flex: 1; padding: 20px; border: 2px solid ${data.correctAnswer === 'true' ? '#4ade80' : '#e5e7eb'}; background: ${data.correctAnswer === 'true' ? 'rgba(74, 222, 128, 0.05)' : 'white'}; border-radius: 12px; text-align: center;">
                  <span style="font-size: 32px; color: #22c55e;">‚úì</span>
                  <p style="font-weight: bold; margin-top: 8px;">True</p>
                  ${data.correctAnswer === 'true' ? '<p style="color: #22c55e; font-size: 12px; margin-top: 4px;">CORRECT</p>' : ''}
                </div>
                <div style="flex: 1; padding: 20px; border: 2px solid ${data.correctAnswer === 'false' ? '#4ade80' : '#e5e7eb'}; background: ${data.correctAnswer === 'false' ? 'rgba(74, 222, 128, 0.05)' : 'white'}; border-radius: 12px; text-align: center;">
                  <span style="font-size: 32px; color: #ef4444;">‚úó</span>
                  <p style="font-weight: bold; margin-top: 8px;">False</p>
                  ${data.correctAnswer === 'false' ? '<p style="color: #22c55e; font-size: 12px; margin-top: 4px;">CORRECT</p>' : ''}
                </div>
              </div>
            `;
          }
          break;

        case 'sentence_ordering':
          if (data.correctSentence) {
            const words = data.correctSentence.split(' ');
            html += `
              ${data.translation ? `<p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">${data.translation}</p>` : ''}
              <div style="padding: 16px; background: rgba(74, 222, 128, 0.1); border: 2px solid #4ade80; border-radius: 12px; margin-bottom: 12px;">
                <p style="font-size: 12px; font-weight: bold; color: #15803d; margin-bottom: 8px;">CORRECT ORDER:</p>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${words.map(word => `<span style="padding: 8px 16px; background: white; border: 2px solid #4ade80; border-radius: 8px; font-size: 18px; font-weight: bold;">${word}</span>`).join('')}
                </div>
              </div>
              <p style="font-size: 12px; color: #6b7280;">Students will drag and drop these words to form the correct sentence</p>
            `;
          }
          break;

        case 'error_correction':
          if (data.incorrectSentence) {
            const words = data.incorrectSentence.split(' ');
            html += `
              <div style="padding: 20px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 12px; margin-bottom: 16px;">
                <p style="font-size: 12px; font-weight: bold; color: #dc2626; margin-bottom: 8px;">INCORRECT SENTENCE:</p>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                  ${words.map((word, idx) => `
                    <span style="padding: 8px 12px; background: ${idx == data.errorIndex ? '#fee2e2' : 'white'}; border: 2px solid ${idx == data.errorIndex ? '#dc2626' : '#e5e7eb'}; border-radius: 8px; font-size: 20px; font-weight: bold;">
                      ${word}
                      ${idx == data.errorIndex ? '<br><span style="font-size: 10px; color: #dc2626;">ERROR ‚ùå</span>' : ''}
                    </span>
                  `).join('')}
                </div>
              </div>
              ${data.correctSentence ? `
                <div style="padding: 16px; background: rgba(74, 222, 128, 0.1); border: 2px solid #4ade80; border-radius: 12px;">
                  <p style="font-size: 12px; font-weight: bold; color: #15803d; margin-bottom: 4px;">CORRECT:</p>
                  <p style="font-size: 20px; font-weight: bold;">${data.correctSentence}</p>
                </div>
              ` : ''}
            `;
          }
          break;

        case 'dictation':
          html += `
            <div style="padding: 24px; background: linear-gradient(135deg, rgba(68, 143, 228, 0.1), rgba(80, 227, 194, 0.1)); border: 2px solid rgba(68, 143, 228, 0.3); border-radius: 16px; text-align: center; margin-bottom: 16px;">
              <span class="material-symbols-outlined" style="font-size: 48px; color: #448fe4;">headphones</span>
              <p style="margin-top: 12px; font-weight: 600;">Listen to Audio</p>
              <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Students will type what they hear</p>
            </div>
            ${data.targetPhrase ? `
              <div style="padding: 16px; background: rgba(74, 222, 128, 0.1); border: 2px solid #4ade80; border-radius: 12px;">
                <p style="font-size: 12px; font-weight: bold; color: #15803d; margin-bottom: 4px;">CORRECT ANSWER:</p>
                <p style="font-size: 24px; font-weight: bold;">${data.targetPhrase}</p>
              </div>
            ` : ''}
          `;
          break;

        case 'cloze_test':
          if (data.passage) {
            // Display passage with blanks highlighted
            const passageWithHighlight = data.passage.replace(/___/g, '<span style="display: inline-block; min-width: 80px; border-bottom: 2px solid #448fe4; padding: 0 8px; margin: 0 4px;">___</span>');

            html += `
              <div style="padding: 24px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px;">
                <p style="font-size: 20px; line-height: 1.8; text-align: center;">${passageWithHighlight}</p>
              </div>
            `;

            // Display answers for each blank
            if (data.blanks && data.blanks.length > 0) {
              html += '<div style="margin-top: 16px;">';
              html += '<p style="font-size: 12px; font-weight: bold; color: #6b7280; margin-bottom: 12px;">CORRECT ANSWERS:</p>';

              data.blanks.forEach((blank, index) => {
                html += `
                  <div style="padding: 12px 16px; background: rgba(74, 222, 128, 0.1); border-left: 4px solid #4ade80; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: baseline; gap: 12px;">
                      <span style="font-size: 14px; font-weight: bold; color: #15803d;">Blank ${blank.blank_num || (index + 1)}:</span>
                      <span style="font-size: 18px; font-weight: bold;">${blank.correct}</span>
                    </div>
                    ${blank.acceptable && blank.acceptable.length > 0 ? `
                      <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        Also accepted: ${blank.acceptable.join(', ')}
                      </p>
                    ` : ''}
                  </div>
                `;
              });

              html += '</div>';
            }
          }
          break;

        case 'image_association':
          html += `
            <div style="margin-bottom: 16px; text-align: center;">
              ${data.imageUrl ? `
                <img src="${data.imageUrl}" style="width: 200px; height: 200px; object-fit: cover; border-radius: 16px; border: 3px solid #e5e7eb;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              ` : ''}
              <div style="${data.imageUrl ? 'display: none;' : 'display: flex;'} width: 200px; height: 200px; border-radius: 16px; background: #f3f4f6; align-items: center; justify-content: center; margin: 0 auto;">
                <span style="font-size: 64px;">üñºÔ∏è</span>
              </div>
            </div>
            ${data.options ? renderPreviewContent({type: 'multiple_choice', options: data.options}) : ''}
          `;
          break;
      }

      return html;
    }

    function closePreview() {
      const modal = document.getElementById('previewModal');
      if (modal) modal.remove();
    }

    // Save question
    async function saveQuestion() {
      // Check if we're editing
      const saveBtn = document.querySelector('button[onclick="saveQuestion()"]');
      const editId = saveBtn?.getAttribute('data-edit-id');

      console.log('üîç saveQuestion called');
      console.log('  - Edit ID:', editId || 'NONE (creating new)');
      console.log('  - Button text:', saveBtn?.textContent);
      console.log('  - Selected type:', selectedType);

      if (!selectedType) {
        alert('Please select a question type first!');
        return;
      }

      // Validate required fields
      const hskLevel = document.getElementById('hskLevel')?.value;
      if (!hskLevel) {
        alert('‚ùå Please select an HSK level!');
        return;
      }

      // Collect form data based on question type
      const questionData = collectCompleteFormData();

      if (!questionData) {
        alert('‚ùå Please fill in all required fields!');
        return;
      }

      console.log(editId ? 'Updating' : 'Saving', 'question data:', questionData);

      try {
        // Get admin password from localStorage or prompt
        let adminPassword = localStorage.getItem('adminPassword');
        if (!adminPassword) {
          adminPassword = prompt('Enter admin password:');
          if (!adminPassword) return;
          localStorage.setItem('adminPassword', adminPassword);
        }

        // Send to backend API
        const url = editId ? `/api/admin/quizzes/${editId}` : '/api/admin/quizzes';
        const method = editId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Password': adminPassword
          },
          body: JSON.stringify(questionData)
        });

        if (!response.ok) {
          if (response.status === 403) {
            localStorage.removeItem('adminPassword');
            throw new Error('Invalid admin password');
          }
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        console.log(editId ? '‚úÖ Question updated:' : '‚úÖ Question saved:', result);

        if (editId) {
          alert('‚úÖ Question updated successfully!');
          window.location.href = '/admin/admin-questions-list.html';
        } else {
          alert('‚úÖ Question saved successfully!\n\nQuestion ID: ' + result.id);

          // Clear any edit state before asking
          const saveBtn = document.querySelector('button[onclick="saveQuestion()"]');
          if (saveBtn) {
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'üíæ Save Question';
          }

          // Reset form
          if (confirm('Question saved! Create another one?')) {
            location.reload();
          } else {
            // Redirect to questions list
            window.location.href = '/admin/admin-questions-list.html';
          }
        }
      } catch (error) {
        console.error('‚ùå Error saving question:', error);
        alert('‚ùå Failed to save question: ' + error.message);
      }
    }

    // Collect complete form data for database
    function collectCompleteFormData() {
      const hskLevel = document.getElementById('hskLevel')?.value;
      const tags = document.getElementById('tags')?.value.split(',').map(t => t.trim()).filter(t => t);
      const explanation = document.getElementById('explanation')?.value;

      if (!hskLevel) return null;

      // Convert HSK level from "HSK1" to 1
      let questionData = {
        question_type: selectedType,
        hsk_level: hskLevel, // Keep as 'HSK1', 'HSK2', etc.
        tags: tags.length > 0 ? tags.join(',') : null,
        explanation: explanation || null,
        difficulty: 'medium', // Default difficulty
        status: 'active', // Default status
        lesson_id: null // Can be updated later to link to specific lesson
      };

      // Collect type-specific data
      switch(selectedType) {
        case 'multiple_choice':
        case 'image_association':
        case 'audio_to_word':
          const questionText = document.getElementById('questionText')?.value;
          const chineseText = document.getElementById('chineseText')?.value;
          const audioUrl = document.getElementById('audioUrl')?.value;
          const imageUrl = document.getElementById('imageUrl')?.value;

          if (!questionText) return null;

          const options = [
            { id: 'a', text: document.getElementById('option_a')?.value || '' },
            { id: 'b', text: document.getElementById('option_b')?.value || '' },
            { id: 'c', text: document.getElementById('option_c')?.value || '' },
            { id: 'd', text: document.getElementById('option_d')?.value || '' }
          ];

          // Find correct answer
          let correctAnswer = '';
          if (document.getElementById('correct_a')?.checked) correctAnswer = options[0].text;
          else if (document.getElementById('correct_b')?.checked) correctAnswer = options[1].text;
          else if (document.getElementById('correct_c')?.checked) correctAnswer = options[2].text;
          else if (document.getElementById('correct_d')?.checked) correctAnswer = options[3].text;

          if (!correctAnswer) return null;

          questionData.question = questionText;
          if (chineseText) questionData.question += ' - ' + chineseText;
          if (audioUrl) questionData.question += ' [audio: ' + audioUrl + ']';
          if (imageUrl) questionData.question += ' [image: ' + imageUrl + ']';
          questionData.options = JSON.stringify(options.map(o => o.text));
          questionData.correct_answer = correctAnswer;
          break;

        case 'audio_comprehension':
          const acQuestionText = document.getElementById('questionText')?.value;
          const acAudioUrl = document.getElementById('audioUrl')?.value;
          const transcript = document.getElementById('transcript')?.value || '';
          const comprehensionQuestion = document.getElementById('comprehensionQuestion')?.value;

          if (!acQuestionText || !acAudioUrl || !comprehensionQuestion) return null;

          const acOptions = [
            { id: 'a', text: document.getElementById('option_a')?.value || '' },
            { id: 'b', text: document.getElementById('option_b')?.value || '' },
            { id: 'c', text: document.getElementById('option_c')?.value || '' },
            { id: 'd', text: document.getElementById('option_d')?.value || '' }
          ];

          // Find correct answer
          let acCorrectAnswer = '';
          if (document.getElementById('correct_a')?.checked) acCorrectAnswer = acOptions[0].text;
          else if (document.getElementById('correct_b')?.checked) acCorrectAnswer = acOptions[1].text;
          else if (document.getElementById('correct_c')?.checked) acCorrectAnswer = acOptions[2].text;
          else if (document.getElementById('correct_d')?.checked) acCorrectAnswer = acOptions[3].text;

          if (!acCorrectAnswer) return null;

          // Store with tags: [audio: url] [transcript: text] [compQuestion: text]
          questionData.question = acQuestionText + ' [audio: ' + acAudioUrl + ']';
          if (transcript) {
            questionData.question += ' [transcript: ' + transcript + ']';
          }
          questionData.question += ' [compQuestion: ' + comprehensionQuestion + ']';
          questionData.options = JSON.stringify(acOptions.map(o => o.text));
          questionData.correct_answer = acCorrectAnswer;
          break;

        case 'grammar_choice':
          const grammarQuestionText = document.getElementById('questionText')?.value;
          const grammarSentenceText = document.getElementById('sentenceText')?.value;

          if (!grammarQuestionText || !grammarSentenceText) return null;

          const grammarOptions = [
            { id: 'a', text: document.getElementById('option_a')?.value || '' },
            { id: 'b', text: document.getElementById('option_b')?.value || '' },
            { id: 'c', text: document.getElementById('option_c')?.value || '' }
          ];

          // Find correct answer
          let grammarCorrectAnswer = '';
          if (document.getElementById('correct_a')?.checked) grammarCorrectAnswer = grammarOptions[0].text;
          else if (document.getElementById('correct_b')?.checked) grammarCorrectAnswer = grammarOptions[1].text;
          else if (document.getElementById('correct_c')?.checked) grammarCorrectAnswer = grammarOptions[2].text;

          if (!grammarCorrectAnswer) return null;

          // Store both question and sentence, separated by a delimiter
          questionData.question = grammarQuestionText + ' [sentence: ' + grammarSentenceText + ']';
          questionData.options = JSON.stringify(grammarOptions.map(o => o.text));
          questionData.correct_answer = grammarCorrectAnswer;
          break;

        case 'fill_gap':
          const sentence = document.getElementById('sentenceText')?.value;
          const translation = document.getElementById('translation')?.value;
          const fillCorrect = document.getElementById('correctAnswer')?.value;
          
          if (!sentence || !fillCorrect) return null;

          questionData.question = sentence + (translation ? ' (' + translation + ')' : '');
          questionData.correct_answer = fillCorrect;
          questionData.options = JSON.stringify([fillCorrect]); // Store for reference
          break;

        case 'true_false':
          const statement = document.getElementById('statement')?.value;
          const tfAnswer = document.querySelector('input[name="trueFalse"]:checked')?.value;
          
          if (!statement || !tfAnswer) return null;

          questionData.question = statement;
          questionData.correct_answer = tfAnswer;
          questionData.options = JSON.stringify(['true', 'false']);
          break;

        case 'sentence_ordering':
          const orderQuestion = document.getElementById('questionText')?.value;
          const correctSentence = document.getElementById('correctSentence')?.value;
          const orderTranslation = document.getElementById('translation')?.value;
          
          if (!orderQuestion || !correctSentence) return null;

          questionData.question = orderQuestion + (orderTranslation ? ' (' + orderTranslation + ')' : '');
          questionData.correct_answer = correctSentence;
          questionData.options = JSON.stringify(correctSentence.split(' '));
          break;

        case 'error_correction':
          const errorQuestion = document.getElementById('questionText')?.value;
          const incorrectSentence = document.getElementById('incorrectSentence')?.value;
          const correctFixed = document.getElementById('correctSentence')?.value;
          const errorIndex = document.getElementById('errorIndex')?.value;
          
          if (!errorQuestion || !incorrectSentence || !correctFixed) return null;

          questionData.question = errorQuestion + ' - ' + incorrectSentence;
          questionData.correct_answer = correctFixed;
          questionData.options = JSON.stringify({ errorIndex: errorIndex, incorrect: incorrectSentence });
          break;

        case 'dictation':
          const dictQuestion = document.getElementById('questionText')?.value;
          const dictAudio = document.getElementById('audioUrl')?.value;
          const dictAnswer = document.getElementById('correctAnswer')?.value;

          if (!dictQuestion || !dictAudio || !dictAnswer) return null;

          questionData.question = dictQuestion + ' [audio: ' + dictAudio + ']';
          questionData.correct_answer = dictAnswer;
          questionData.options = JSON.stringify([dictAnswer]);
          break;

        case 'cloze_test':
          const clozeQuestionText = document.getElementById('questionText')?.value;
          const passage = document.getElementById('passage')?.value;

          if (!clozeQuestionText || !passage) return null;

          // Collect all blank answers dynamically
          const blanksData = [];
          let blankIndex = 1;

          while (true) {
            const answerInput = document.getElementById(`blank_${blankIndex}_answer`);
            const acceptableInput = document.getElementById(`blank_${blankIndex}_acceptable`);

            if (!answerInput || !answerInput.value) break; // No more blanks

            const blankData = {
              blank_num: blankIndex,
              correct: answerInput.value.trim(),
              acceptable: acceptableInput?.value ? acceptableInput.value.split(',').map(a => a.trim()).filter(a => a) : []
            };

            blanksData.push(blankData);
            blankIndex++;
          }

          if (blanksData.length === 0) return null; // Need at least one blank answer

          // Store passage with [passage: text] tag and blanks as JSON in options
          questionData.question = clozeQuestionText + ' [passage: ' + passage + ']';
          questionData.options = JSON.stringify(blanksData);
          // First blank's correct answer as the primary correct_answer
          questionData.correct_answer = blanksData[0].correct;
          break;

        default:
          // For other types, use basic structure
          const basicQuestion = document.getElementById('questionText')?.value;
          if (!basicQuestion) return null;
          questionData.question = basicQuestion;
          questionData.correct_answer = 'N/A';
          questionData.options = JSON.stringify([]);
      }

      return questionData;
    }

    // View all questions
    function viewAllQuestions() {
      window.location.href = '/admin/admin-questions-list.html';
    }

    // Load question for editing
    async function loadQuestionForEdit() {
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');

      console.log('üîç loadQuestionForEdit called, editId:', editId);

      if (!editId) {
        console.log('‚úì No edit ID found, in CREATE mode');
        return; // Not editing, just creating new
      }

      console.log('üìù EDIT MODE - Loading question ID:', editId);

      try {
        const password = await getAdminPassword();
        if (!password) {
          console.error('‚ùå No password provided');
          alert('‚ùå Admin password required to edit questions. Please refresh and enter the password.');
          return; // Don't redirect, let user retry
        }

        console.log('üîê Password obtained, fetching question...');

        // Fetch question from API
        const response = await fetch(`/api/admin/quizzes`, {
          headers: {
            'X-Admin-Password': password
          }
        });

        if (!response.ok) {
          console.error('‚ùå API response not OK:', response.status);
          throw new Error('Failed to load questions: ' + response.status);
        }

        const allQuestions = await response.json();
        console.log('‚úì Loaded', allQuestions.length, 'questions from API');
        
        const question = allQuestions.find(q => q.id == editId);

        if (!question) {
          console.error('‚ùå Question not found with ID:', editId);
          alert('‚ùå Question not found (ID: ' + editId + ')');
          // Don't redirect yet, show the error
          return;
        }

        // Load question data into form
        console.log('‚úÖ Found question to edit:', question);

        // Select question type
        selectQuestionType(question.question_type);

        // Set HSK level
        const hskLevelSelect = document.getElementById('hskLevel');
        if (hskLevelSelect) {
          // Handle both old format (number) and new format (HSK1, HSK2, etc.)
          const hskValue = question.hsk_level;
          if (hskValue && hskValue.toString().startsWith('HSK')) {
            hskLevelSelect.value = hskValue; // Already in HSK1 format
          } else {
            hskLevelSelect.value = 'HSK' + hskValue; // Convert number to HSK1 format
          }
          console.log('‚úì Set HSK level to:', hskLevelSelect.value);
        }

        // Set tags
        const tagsInput = document.getElementById('tags');
        if (tagsInput && question.tags) {
          tagsInput.value = question.tags;
        }

        // Set explanation
        const explanationInput = document.getElementById('explanation');
        if (explanationInput && question.explanation) {
          explanationInput.value = question.explanation;
        }

        // Parse options
        let options = question.options;
        if (typeof options === 'string') {
          try {
            options = JSON.parse(options);
          } catch (e) {
            console.error('Failed to parse options:', e);
            options = {};
          }
        }

        // Load type-specific fields
        setTimeout(() => {
          const questionTextInput = document.getElementById('questionText');
          const chineseTextInput = document.getElementById('chineseText');
          const audioUrlInput = document.getElementById('audioUrl');
          const imageUrlInput = document.getElementById('imageUrl');
          const correctAnswerInput = document.getElementById('correctAnswer');

          // Parse question text that might contain " - ‰∏≠Êñá", "[audio: url]", or "[image: url]"
          let questionText = question.question || '';
          let chineseText = '';
          let audioUrl = '';
          let imageUrl = '';

          console.log('üîç Original question text:', questionText);

          // Extract audio URL from [audio: url] format
          const audioMatch = questionText.match(/\[audio:\s*(.+?)\]/);
          if (audioMatch) {
            audioUrl = audioMatch[1];
            questionText = questionText.replace(/\[audio:\s*.+?\]/, '').trim();
            console.log('üéµ Extracted audio URL:', audioUrl);
          }

          // Extract image URL from [image: url] format
          const imageMatch = questionText.match(/\[image:\s*(.+?)\]/);
          if (imageMatch) {
            imageUrl = imageMatch[1];
            questionText = questionText.replace(/\[image:\s*.+?\]/, '').trim();
            console.log('üñºÔ∏è Extracted image URL:', imageUrl);
          }

          console.log('üìù Final question text after extraction:', questionText);

          // Extract Chinese text from " - ‰∏≠Êñá" format
          const chineseMatch = questionText.match(/\s+-\s+(.+)$/);
          if (chineseMatch) {
            chineseText = chineseMatch[1];
            questionText = questionText.replace(/\s+-\s+.+$/, '').trim();
          }

          console.log('üìã Setting form values:');
          console.log('  - questionTextInput exists:', !!questionTextInput);
          console.log('  - chineseTextInput exists:', !!chineseTextInput);
          console.log('  - audioUrlInput exists:', !!audioUrlInput);
          console.log('  - imageUrlInput exists:', !!imageUrlInput);
          console.log('  - correctAnswerInput exists:', !!correctAnswerInput);

          if (questionTextInput) {
            questionTextInput.value = questionText;
            console.log('  ‚úì Set questionText to:', questionText);
          }
          if (chineseTextInput) {
            chineseTextInput.value = chineseText || question.chinese_text || '';
            console.log('  ‚úì Set chineseText to:', chineseText || question.chinese_text || '');
          }
          if (audioUrlInput) {
            audioUrlInput.value = audioUrl || question.audio_url || '';
            console.log('  ‚úì Set audioUrl to:', audioUrl || question.audio_url || '');

            // Show audio preview if audio URL exists
            if (audioUrl) {
              const audioPreview = document.getElementById('audioPreview');
              const audioUrlDisplay = document.getElementById('audioUrlDisplay');
              const currentAudioDisplay = document.getElementById('currentAudioDisplay');

              if (audioPreview && audioUrlDisplay && currentAudioDisplay) {
                audioPreview.src = audioUrl;
                audioUrlDisplay.textContent = audioUrl;
                currentAudioDisplay.classList.remove('hidden');
                console.log('  üéµ Audio preview displayed');
              }
            }
          }
          if (imageUrlInput) {
            imageUrlInput.value = imageUrl || question.image_url || '';
            console.log('  ‚úì Set imageUrl to:', imageUrl || question.image_url || '');
          }
          if (correctAnswerInput) {
            correctAnswerInput.value = question.correct_answer || '';
            console.log('  ‚úì Set correctAnswer to:', question.correct_answer || '');
          }

          // Show image preview if image URL exists
          if (imageUrl && imageUrlInput) {
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');
            if (imagePreview) {
              imagePreview.src = imageUrl;
              imagePreview.classList.remove('hidden');
              if (imagePreviewPlaceholder) {
                imagePreviewPlaceholder.classList.add('hidden');
              }
              console.log('  üñºÔ∏è Image preview displayed');
            }
          }

          // Load multiple choice options - handle both array and object formats
          if (Array.isArray(options)) {
            // Array format: ["Hello", "Goodbye", "Thanks", "Sorry"]
            const letters = ['a', 'b', 'c', 'd'];
            options.forEach((optionText, index) => {
              const optionInput = document.getElementById(`option_${letters[index]}`);
              if (optionInput && optionText) {
                optionInput.value = optionText;
              }
            });

            // Set correct answer radio button
            const correctAnswer = question.correct_answer;
            if (correctAnswer) {
              const correctIndex = options.indexOf(correctAnswer);
              if (correctIndex >= 0) {
                const radioButton = document.getElementById(`correct_${letters[correctIndex]}`);
                if (radioButton) radioButton.checked = true;
              }
            }
          } else if (options && typeof options === 'object') {
            // Object format: {a: "Hello", b: "Goodbye", ...}
            ['a', 'b', 'c', 'd'].forEach(key => {
              const optionInput = document.getElementById(`option_${key}`);
              if (optionInput && options[key]) {
                optionInput.value = options[key];
              }
            });

            // Set correct answer radio button
            const correctAnswer = question.correct_answer;
            if (correctAnswer) {
              ['a', 'b', 'c', 'd'].forEach(key => {
                if (options[key] === correctAnswer) {
                  const radioButton = document.getElementById(`correct_${key}`);
                  if (radioButton) radioButton.checked = true;
                }
              });
            }
          }

          // Load matching pairs
          if (selectedType === 'matching' && Array.isArray(options)) {
            options.forEach((pair, index) => {
              const pairNum = index + 1;
              const leftInput = document.getElementById(`chinese_${pairNum}`);
              const rightInput = document.getElementById(`english_${pairNum}`);
              if (leftInput && rightInput) {
                leftInput.value = pair.left || '';
                rightInput.value = pair.right || '';
              }
            });
          }

          // Load grammar_choice data
          if (selectedType === 'grammar_choice') {
            // Extract sentence from [sentence: text] format
            let grammarQuestionText = question.question || '';
            let grammarSentenceText = '';

            const sentenceMatch = grammarQuestionText.match(/\[sentence:\s*(.+?)\]/);
            if (sentenceMatch) {
              grammarSentenceText = sentenceMatch[1];
              grammarQuestionText = grammarQuestionText.replace(/\[sentence:\s*.+?\]/, '').trim();
            }

            if (questionTextInput) {
              questionTextInput.value = grammarQuestionText;
              console.log('  ‚úì Set grammar question to:', grammarQuestionText);
            }

            const sentenceTextInput = document.getElementById('sentenceText');
            if (sentenceTextInput) {
              sentenceTextInput.value = grammarSentenceText;
              console.log('  ‚úì Set sentence text to:', grammarSentenceText);
            }

            // Load grammar options (A, B, C)
            if (Array.isArray(options)) {
              const letters = ['a', 'b', 'c'];
              options.forEach((optionText, index) => {
                const optionInput = document.getElementById(`option_${letters[index]}`);
                if (optionInput && optionText) {
                  optionInput.value = optionText;
                }
              });

              // Set correct answer radio button
              const correctAnswer = question.correct_answer;
              if (correctAnswer) {
                const correctIndex = options.indexOf(correctAnswer);
                if (correctIndex >= 0) {
                  const radioButton = document.getElementById(`correct_${letters[correctIndex]}`);
                  if (radioButton) {
                    radioButton.checked = true;
                    console.log('  ‚úì Checked correct grammar option:', letters[correctIndex]);
                  }
                }
              }
            }
          }

          // Load true/false data
          if (selectedType === 'true_false') {
            const statementInput = document.getElementById('statement');
            if (statementInput) {
              statementInput.value = question.question || '';
              console.log('  ‚úì Set statement to:', question.question);
            }

            // Set the correct radio button
            const correctAnswer = question.correct_answer; // "true" or "false"
            if (correctAnswer === 'true') {
              const trueRadio = document.getElementById('true');
              if (trueRadio) {
                trueRadio.checked = true;
                console.log('  ‚úì Checked TRUE radio button');
              }
            } else if (correctAnswer === 'false') {
              const falseRadio = document.getElementById('false');
              if (falseRadio) {
                falseRadio.checked = true;
                console.log('  ‚úì Checked FALSE radio button');
              }
            }
          }

          // Load audio_comprehension data
          if (selectedType === 'audio_comprehension') {
            // Extract audio, transcript, and comprehension question from tags
            let acQuestionText = question.question || '';
            let acAudioUrl = '';
            let acTranscript = '';
            let acCompQuestion = '';

            // Extract audio URL
            const audioMatch = acQuestionText.match(/\[audio:\s*([^\]]+)\]/);
            if (audioMatch) {
              acAudioUrl = audioMatch[1];
            }

            // Extract transcript - match until [compQuestion: starts (if present)
            const transcriptMatch = acQuestionText.match(/\[transcript:\s*(.+?)\]\s*\[compQuestion:/);
            if (transcriptMatch) {
              acTranscript = transcriptMatch[1];
            }

            // Extract comprehension question - match until end of string
            const compQuestionMatch = acQuestionText.match(/\[compQuestion:\s*(.+?)\]$/);
            if (compQuestionMatch) {
              acCompQuestion = compQuestionMatch[1];
            }

            // Remove all tags to get clean question text
            acQuestionText = acQuestionText.replace(/\[audio:[^\]]+\]/, '').trim();
            if (acTranscript) {
              acQuestionText = acQuestionText.replace(/\[transcript:.+?\]/, '').trim();
            }
            acQuestionText = acQuestionText.replace(/\[compQuestion:.+?\]$/, '').trim();

            if (questionTextInput) {
              questionTextInput.value = acQuestionText;
              console.log('  ‚úì Set audio comp question to:', acQuestionText);
            }

            const audioUrlInput = document.getElementById('audioUrl');
            if (audioUrlInput) {
              audioUrlInput.value = acAudioUrl;
              console.log('  ‚úì Set audio URL to:', acAudioUrl);
            }

            const transcriptInput = document.getElementById('transcript');
            if (transcriptInput) {
              transcriptInput.value = acTranscript;
              console.log('  ‚úì Set transcript to:', acTranscript);
            }

            const compQuestionInput = document.getElementById('comprehensionQuestion');
            if (compQuestionInput) {
              compQuestionInput.value = acCompQuestion;
              console.log('  ‚úì Set comprehension question to:', acCompQuestion);
            }

            // Load options (A, B, C, D)
            if (Array.isArray(options)) {
              const letters = ['a', 'b', 'c', 'd'];
              options.forEach((optionText, index) => {
                const optionInput = document.getElementById(`option_${letters[index]}`);
                if (optionInput && optionText) {
                  optionInput.value = optionText;
                }
              });

              // Set correct answer radio button
              const correctAnswer = question.correct_answer;
              if (correctAnswer) {
                const correctIndex = options.indexOf(correctAnswer);
                if (correctIndex >= 0) {
                  const radioButton = document.getElementById(`correct_${letters[correctIndex]}`);
                  if (radioButton) {
                    radioButton.checked = true;
                    console.log('  ‚úì Checked correct option:', letters[correctIndex]);
                  }
                }
              }
            }
          }

          // Load cloze_test data
          if (selectedType === 'cloze_test') {
            // Extract passage from [passage: text] format
            let clozeQuestionText = question.question || '';
            let passageText = '';

            const passageMatch = clozeQuestionText.match(/\[passage:\s*(.+?)\]$/);
            if (passageMatch) {
              passageText = passageMatch[1];
              clozeQuestionText = clozeQuestionText.replace(/\[passage:\s*.+?\]$/, '').trim();
            }

            if (questionTextInput) {
              questionTextInput.value = clozeQuestionText;
              console.log('  ‚úì Set cloze question to:', clozeQuestionText);
            }

            const passageInput = document.getElementById('passage');
            if (passageInput) {
              passageInput.value = passageText;
              console.log('  ‚úì Set passage to:', passageText);
            }

            // Load blank answers from options JSON
            if (Array.isArray(options)) {
              options.forEach((blankData, index) => {
                const blankNum = blankData.blank_num || (index + 1);
                const answerInput = document.getElementById(`blank_${blankNum}_answer`);
                const acceptableInput = document.getElementById(`blank_${blankNum}_acceptable`);

                if (answerInput && blankData.correct) {
                  answerInput.value = blankData.correct;
                  console.log(`  ‚úì Set blank ${blankNum} answer to:`, blankData.correct);
                }

                if (acceptableInput && blankData.acceptable && Array.isArray(blankData.acceptable)) {
                  acceptableInput.value = blankData.acceptable.join(', ');
                  console.log(`  ‚úì Set blank ${blankNum} acceptable to:`, blankData.acceptable.join(', '));
                }
              });
            }
          }

          // Load fill_gap data
          if (selectedType === 'fill_gap') {
            // Format: "Complete the sentence: - Êàë ___ Â≠¶Áîü (I ___ a student.)"
            let fillGapQuestionText = question.question || '';
            let heading = '';
            let sentence = '';
            let translation = '';

            // Split on " - " to separate heading from sentence
            const dashMatch = fillGapQuestionText.match(/^(.+?)\s*-\s*(.+)$/);
            if (dashMatch) {
              heading = dashMatch[1].trim();
              sentence = dashMatch[2].trim();

              // Extract translation from parentheses at the end
              const translationMatch = sentence.match(/\s*\((.+?)\)\s*$/);
              if (translationMatch) {
                translation = translationMatch[1].trim();
                sentence = sentence.replace(/\s*\(.+?\)\s*$/, '').trim();
              }
            } else {
              // Fallback: use entire question as heading
              heading = fillGapQuestionText;
            }

            if (questionTextInput) {
              questionTextInput.value = heading;
              console.log('  ‚úì Set fill_gap heading to:', heading);
            }

            const sentenceTextInput = document.getElementById('sentenceText');
            if (sentenceTextInput) {
              sentenceTextInput.value = sentence;
              console.log('  ‚úì Set sentence text to:', sentence);
            }

            const translationInput = document.getElementById('translation');
            if (translationInput && translation) {
              translationInput.value = translation;
              console.log('  ‚úì Set translation to:', translation);
            }

            // Load correct answer
            const correctAnswerInput = document.getElementById('correctAnswer');
            if (correctAnswerInput) {
              correctAnswerInput.value = question.correct_answer || '';
              console.log('  ‚úì Set correct answer to:', question.correct_answer);
            }

            // Load acceptable answers from acceptable_answers JSONB field
            const acceptableAnswersInput = document.getElementById('acceptableAnswers');
            if (acceptableAnswersInput && question.acceptable_answers) {
              let acceptableList = [];
              if (Array.isArray(question.acceptable_answers)) {
                acceptableList = question.acceptable_answers;
              } else if (typeof question.acceptable_answers === 'object') {
                acceptableList = Object.values(question.acceptable_answers);
              }
              acceptableAnswersInput.value = acceptableList.join(', ');
              console.log('  ‚úì Set acceptable answers to:', acceptableList.join(', '));
            }
          }

          // Update Save button to indicate editing
          const saveBtn = document.querySelector('button[onclick="saveQuestion()"]');
          if (saveBtn) {
            saveBtn.textContent = 'üíæ Update Question';
            saveBtn.setAttribute('data-edit-id', editId);
          }
        }, 500); // Wait for form to render

      } catch (error) {
        console.error('Error loading question:', error);
        alert('‚ùå Failed to load question: ' + error.message);
      }
    }

    // Load question for editing on page load
    console.log('üöÄ About to check document.readyState:', document.readyState);
    console.log('üöÄ Current URL:', window.location.href);
    console.log('üöÄ URL search params:', window.location.search);

    if (document.readyState === 'loading') {
      console.log('üìå Attaching DOMContentLoaded listener');
      document.addEventListener('DOMContentLoaded', () => {
        console.log('‚úÖ DOM loaded via event, calling loadQuestionForEdit');
        loadQuestionForEdit().catch(err => console.error('‚ùå loadQuestionForEdit error:', err));
      });
    } else {
      // DOM already loaded (script is at bottom of page)
      console.log('‚úÖ DOM already loaded, calling loadQuestionForEdit immediately');
      setTimeout(() => {
        console.log('‚è∞ Calling loadQuestionForEdit after 100ms delay');
        loadQuestionForEdit().catch(err => console.error('‚ùå loadQuestionForEdit error:', err));
      }, 100);
    }
  </script>
</body>
</html>
