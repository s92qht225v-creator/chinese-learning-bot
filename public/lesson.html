<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>HSK Lesson</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#448fe4",
          "warning": "#FFC107",
          "success": "#4CAF50",
          "background-light": "#f6f7f8",
          "background-dark": "#111921",
          "surface-light": "#ffffff",
          "surface-dark": "#18222c",
          "text-primary-light": "#111417",
          "text-primary-dark": "#f0f4f8",
          "text-secondary-light": "#647487",
          "text-secondary-dark": "#a0aec0",
          "border-light": "#dce0e5",
          "border-dark": "#2d3748",
        },
        fontFamily: {
          "display": ["Work Sans", "sans-serif"],
          "chinese": ["Noto Sans SC", "sans-serif"]
        },
        borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"},
      },
    },
  }
</script>
<style>
  body {
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* Progress Timeline Segments */
  .progress-segment {
    flex: 1;
    padding: 0.5rem;
    text-align: center;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }
  
  .progress-segment.completed {
    background: #4CAF50;
    color: white;
  }
  
  .progress-segment.active {
    background: #448fe4;
    color: white;
  }
  
  .progress-segment.pending {
    background: rgba(100, 116, 135, 0.1);
    color: #647487;
  }
  
  /* Section Icons */
  .section-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    background: rgba(68, 143, 228, 0.1);
    color: #448fe4;
  }
  
  /* Vocabulary Mastery Bar */
  .mastery-bar {
    height: 0.25rem;
    background: #dce0e5;
    border-radius: 9999px;
    overflow: hidden;
  }
  
  .mastery-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #448fe4);
    transition: width 0.3s ease;
  }
  
  /* Status Badges */
  .status-badge {
    font-size: 0.625rem;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-weight: 600;
  }
  
  .status-badge.new {
    background: #4CAF50;
    color: white;
  }
  
  .status-badge.learning {
    background: #FFC107;
    color: #000;
  }
  
  .status-badge.mastered {
    background: #448fe4;
    color: white;
  }
  
  /* Grammar Pattern Box */
  .grammar-pattern-box {
    background: rgba(68, 143, 228, 0.08);
    border-left: 3px solid #448fe4;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-family: 'Courier New', monospace;
    font-weight: 600;
  }
  
  /* Word Highlighting */
  .word-highlight {
    color: #448fe4;
    font-weight: 700;
    padding: 0 0.125rem;
  }
  
  /* Example Sentences */
  .example-sentence {
    background: rgba(68, 143, 228, 0.05);
    border-radius: 0.5rem;
    padding: 0.75rem;
  }
  
  /* Audio Playing Animation */
  @keyframes pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  
  .audio-playing {
    animation: pulse-subtle 1.5s ease-in-out infinite;
  }
  
  /* Material Icons */
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }
  
  .material-symbols-outlined.filled {
    font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24;
  }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark">

<div class="relative flex min-h-screen w-full flex-col">
  
  <!-- Header -->
  <div class="sticky top-0 z-10 flex items-center bg-surface-light/95 dark:bg-surface-dark/95 p-4 pb-2 justify-between backdrop-blur-md border-b border-border-light dark:border-border-dark">
    <div class="flex size-12 shrink-0 items-center">
      <button onclick="window.history.back()" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
        <span class="material-symbols-outlined text-text-primary-light dark:text-text-primary-dark">arrow_back</span>
      </button>
    </div>
    <h1 id="lessonTitle" class="text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Loading...</h1>
    <div class="flex w-12 items-center justify-end">
      <button id="completeBtn" onclick="markLessonComplete()" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-transparent text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
        <span class="material-symbols-outlined">check_circle</span>
      </button>
    </div>
  </div>

  <main class="flex-1 p-4 pb-24">
    <!-- Audio Player -->
    <div data-section="audio" class="flex flex-col gap-4 rounded-xl bg-surface-light dark:bg-surface-dark p-4 mb-4 shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
      <div class="flex items-center justify-between gap-4">
        <div class="flex flex-col gap-1 flex-[2_2_0px]">
          <p id="audioTitle" class="text-base font-bold leading-tight">Lesson Audio</p>
          <p class="text-sm font-normal leading-normal text-text-secondary-light dark:text-text-secondary-dark">Main Dialogue</p>
        </div>
        <div class="w-20 h-20 bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg flex-shrink-0 flex items-center justify-center">
          <span class="material-symbols-outlined text-4xl text-primary">headphones</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <button id="audioPlayBtn" class="flex items-center justify-center h-12 w-12 rounded-full bg-primary text-white hover:bg-primary/90 transition-all active:scale-95">
          <span class="material-symbols-outlined text-3xl">play_arrow</span>
        </button>
        <div class="flex flex-col gap-1 w-full">
          <div class="rounded-full bg-border-light dark:bg-border-dark">
            <div id="audioProgress" class="h-2 rounded-full bg-primary transition-all" style="width: 0%;"></div>
          </div>
          <div class="flex justify-between">
            <p id="audioTime" class="text-xs font-normal leading-normal text-text-secondary-light dark:text-text-secondary-dark">00:00</p>
            <p id="audioDuration" class="text-xs font-normal leading-normal text-text-secondary-light dark:text-text-secondary-dark">00:00</p>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col pt-2 gap-3">
      
      <!-- DIALOGUE SECTION -->
      <details data-section="dialogue" class="flex flex-col rounded-xl bg-surface-light dark:bg-surface-dark shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.1)] border-l-4 border-primary group" open>
        <summary class="flex cursor-pointer items-center gap-3 p-4 list-none">
          <div class="section-icon">
            <span class="material-symbols-outlined">chat_bubble</span>
          </div>
          <div class="flex-1">
            <p class="text-base font-bold leading-normal">Dialogue</p>
            <p id="dialogueCount" class="text-xs text-text-secondary-light dark:text-text-secondary-dark">Loading...</p>
          </div>
          <span class="material-symbols-outlined transition-transform duration-200 group-open:rotate-180 text-text-secondary-light dark:text-text-secondary-dark">expand_more</span>
        </summary>
        
        <div class="border-t border-border-light dark:border-border-dark px-4 pt-3 pb-4">
          <!-- Tabs -->
          <div class="pb-4">
            <div class="flex border-b border-border-light dark:border-border-dark text-center">
              <button onclick="switchDialogueTab('characters')" class="dialogue-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-text-secondary-light dark:text-text-secondary-dark pb-3 pt-2 flex-1 hover:text-primary transition-colors" data-tab="characters">
                <p class="text-sm font-bold leading-normal tracking-[0.015em]">Characters</p>
              </button>
              <button onclick="switchDialogueTab('pinyin')" class="dialogue-tab active flex flex-col items-center justify-center border-b-[3px] border-b-primary text-primary pb-3 pt-2 flex-1" data-tab="pinyin">
                <p class="text-sm font-bold leading-normal tracking-[0.015em]">+ Pinyin</p>
              </button>
              <button onclick="switchDialogueTab('translation')" class="dialogue-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-text-secondary-light dark:text-text-secondary-dark pb-3 pt-2 flex-1 hover:text-primary transition-colors" data-tab="translation">
                <p class="text-sm font-bold leading-normal tracking-[0.015em]">Translation</p>
              </button>
            </div>
          </div>
          
          <!-- Dialogue Lines -->
          <div id="dialogueContainer" class="flex flex-col gap-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </details>

      <!-- VOCABULARY SECTION -->
      <details data-section="vocab" class="flex flex-col rounded-xl bg-surface-light dark:bg-surface-dark shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.1)] border-l-4 border-warning group">
        <summary class="flex cursor-pointer items-center gap-3 p-4 list-none">
          <div class="section-icon bg-warning/10">
            <span class="material-symbols-outlined text-warning">menu_book</span>
          </div>
          <div class="flex-1">
            <p class="text-base font-bold leading-normal">Vocabulary</p>
            <p id="vocabularyCount" class="text-xs text-text-secondary-light dark:text-text-secondary-dark">Loading...</p>
          </div>
          <span class="material-symbols-outlined transition-transform duration-200 group-open:rotate-180 text-text-secondary-light dark:text-text-secondary-dark">expand_more</span>
        </summary>
        
        <div class="border-t border-border-light dark:border-border-dark px-4 pt-4 pb-4">
          <div id="vocabularyContainer" class="flex flex-col gap-3">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </details>

      <!-- GRAMMAR SECTION -->
      <details data-section="grammar" class="flex flex-col rounded-xl bg-surface-light dark:bg-surface-dark shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.1)] border-l-4 border-success group">
        <summary class="flex cursor-pointer items-center gap-3 p-4 list-none">
          <div class="section-icon bg-success/10">
            <span class="material-symbols-outlined text-success">lightbulb</span>
          </div>
          <div class="flex-1">
            <p class="text-base font-bold leading-normal">Grammar</p>
            <p id="grammarCount" class="text-xs text-text-secondary-light dark:text-text-secondary-dark">Loading...</p>
          </div>
          <span class="material-symbols-outlined transition-transform duration-200 group-open:rotate-180 text-text-secondary-light dark:text-text-secondary-dark">expand_more</span>
        </summary>
        
        <div class="border-t border-border-light dark:border-border-dark px-4 pt-4 pb-4">
          <div id="grammarContainer" class="flex flex-col gap-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </details>

      <!-- EXERCISES SECTION -->
      <details data-section="practice" class="flex flex-col rounded-xl bg-surface-light dark:bg-surface-dark shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.1)] border-l-4 border-primary group">
        <summary class="flex cursor-pointer items-center gap-3 p-4 list-none">
          <div class="section-icon">
            <span class="material-symbols-outlined">quiz</span>
          </div>
          <div class="flex-1">
            <p class="text-base font-bold leading-normal">Exercises</p>
            <p id="exercisesCount" class="text-xs text-text-secondary-light dark:text-text-secondary-dark">Loading...</p>
          </div>
          <span class="material-symbols-outlined transition-transform duration-200 group-open:rotate-180 text-text-secondary-light dark:text-text-secondary-dark">expand_more</span>
        </summary>
        
        <div class="border-t border-border-light dark:border-border-dark px-4 pt-4 pb-4">
          <div id="quizzesContainer" class="flex flex-col gap-6">
            <!-- Will be populated by JavaScript -->
          </div>
          <div id="checkAnswersContainer" class="mt-6" style="display: none;">
            <button id="checkAnswersBtn" onclick="checkExerciseAnswers()" class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg transition-all active:scale-95 flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">check_circle</span>
              <span>Check Answers</span>
            </button>
            <div id="exerciseProgress" class="mt-3 text-center text-sm text-text-secondary-light dark:text-text-secondary-dark">
              <span id="correctCount">0</span>/<span id="totalCount">0</span> completed
            </div>
          </div>
        </div>
      </details>

    </div>

    <!-- Complete Lesson Button -->
    <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white shadow-lg">
      <div class="flex items-center justify-between gap-4">
        <div class="flex-1">
          <p class="font-bold text-lg">Ready to finish?</p>
          <p class="text-sm opacity-90">Complete all sections to mark lesson as done</p>
        </div>
        <button id="completeLessonBtn" onclick="completeLesson()" class="px-6 py-3 rounded-lg bg-white text-primary font-bold hover:bg-gray-50 transition-all active:scale-95 flex items-center gap-2 whitespace-nowrap">
          <span>Complete Lesson</span>
          <span class="material-symbols-outlined">check_circle</span>
        </button>
      </div>
    </div>

  </main>
</div>

<script src="/lesson.js"></script>
</body>
</html>